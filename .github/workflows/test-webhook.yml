name: Test Webhook

on:
  workflow_dispatch:
    inputs:
      slack_url:
        description: 'Slackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸URLï¼ˆZapierçµŒç”±ã§æ¸¡ã•ã‚Œã‚‹ï¼‰'
        required: true
        type: string

env:
  NODE_VERSION: '18.20.8'
  NPM_VERSION: '10.8.2'

jobs:
  test-webhook:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout sample-ai-agent
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install specific npm version
        run: npm install -g npm@${{ env.NPM_VERSION }}

      - name: Clean npm cache
        run: npm cache clean --force

      - name: Download and install sample-mcp
        env:
          GH_TOKEN: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
        run: |
          # GitHub APIã‚’ä½¿ã£ã¦tarballã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          echo "Downloading sample-mcp tarball..."
          curl -L -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/Kate-AC/sample-mcp/tarball/main \
            -o sample-mcp.tar.gz
          
          # ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å±•é–‹
          mkdir -p temp-mcp-kit
          tar -xzf sample-mcp.tar.gz -C temp-mcp-kit --strip-components=1
          
          # ãƒ“ãƒ«ãƒ‰ã—ã¦ãƒ‘ãƒƒã‚¯
          cd temp-mcp-kit
          npm ci
          npm run build
          npm pack
          mv *.tgz ../
          cd ..
          
          # package.jsonã®ä¾å­˜ã‚’å¿…ãšãƒ­ãƒ¼ã‚«ãƒ«tarballã«ç½®æ›ï¼ˆè¡¨è¨˜å·®ç•°ã‚’å¸åŽï¼‰
          node -e '
            const fs = require("fs");
            const pkg = JSON.parse(fs.readFileSync("package.json", "utf8"));
            pkg.dependencies = pkg.dependencies || {};
            pkg.dependencies["sample-mcp"] = "file:./sample-mcp-1.0.0.tgz";
            fs.writeFileSync("package.json", JSON.stringify(pkg, null, 2) + "\n");
            console.log("Pinned sample-mcp to local tarball in package.json");
          '

          # lockfileã‚’æ›´æ–°ï¼ˆä¾å­˜è§£æ±ºã‚’tarballã«å›ºå®šï¼‰
          npm install --package-lock-only

      - name: Install dependencies
        run: |
          echo "Checking if sample-mcp tarball exists:"
          ls -la *.tgz || echo "No tarball found"
          echo "Configuring git URL rewrite to use HTTPS with GITHUB_TOKEN"
          git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "ssh://git@github.com/"
          git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "git@github.com:"
          echo "Running npm ci..."
          npm ci

      - name: Setup environment variables
        run: |
          cat > .env << EOF
          AWS_BEARER_TOKEN_BEDROCK=${{ secrets.AWS_BEARER_TOKEN_BEDROCK }}
          SLACK_USER_OAUTH_TOKEN=${{ secrets.SLACK_USER_OAUTH_TOKEN }}
          SLACK_BOT_USER_OAUTH_TOKEN=${{ secrets.SLACK_BOT_USER_OAUTH_TOKEN }}
          SLACK_BOT_USER_NAME=${{ secrets.SLACK_BOT_USER_NAME }}
          REDMINE_API_KEY=${{ secrets.REDMINE_API_KEY }}
          SLACK_BOT_USER_NAME=${{ secrets.SLACK_BOT_USER_NAME }}
          EOF

      - name: Display received URL
        run: |
          echo "ðŸ”— Received Slack URL: ${{ inputs.slack_url }}"
          echo "â° é–‹å§‹æ™‚åˆ»: $(date)"

      - name: Run Slack Monitor with URL
        run: |
          echo "ðŸ¤– Starting Slack Monitor with URL..."
          echo "ðŸ“Ž Processing URL: ${{ inputs.slack_url }}"

          npm run monitor:slack url "${{ inputs.slack_url }}" || {
            echo "âŒ Slack Monitor ãŒå¤±æ•—ã—ã¾ã—ãŸ"
            echo "ðŸ“‹ ã‚¨ãƒ©ãƒ¼è©³ç´°:"
            echo "çµ‚äº†ã‚³ãƒ¼ãƒ‰: $?"
            echo "â° çµ‚äº†æ™‚åˆ»: $(date)"
            exit 1
          }
          
          echo "âœ… Slack Monitor ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
          echo "â° çµ‚äº†æ™‚åˆ»: $(date)"

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ”— Test Webhook Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | å€¤ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| **å®Ÿè¡Œæ—¥æ™‚** | $(date -u '+%Y-%m-%d %H:%M:%S') UTC |" >> $GITHUB_STEP_SUMMARY
          echo "| **å—ã‘å–ã£ãŸURL** | ${{ inputs.slack_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹** | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

